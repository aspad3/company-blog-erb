name: Run Rake Task Twice a Day

on:
  schedule:
    - cron: '0 6,18 * * *'  # 6 pagi & 6 malam
  workflow_dispatch:

jobs:
  run_rake_task:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Install libcurl headers
      - name: Install libcurl development headers
        run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev

      # 3️⃣ Setup Ruby
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.4'

      # 4️⃣ Cache Ruby gems
      - name: Cache Ruby gems
        uses: actions/cache@v3
        with:
          path: ~/.bundle
          key: ${{ runner.os }}-bundle-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-bundle-

      # 5️⃣ Install Bundler
      - name: Install Bundler
        run: gem install bundler

      # 6️⃣ Install dependencies
      - name: Install dependencies
        run: bundle install

      # 8️⃣ Run Rake Task dengan token terbaru
      - name: Run Rake Task
        env:
          GOOGLE_GEMINI_API_KEY: ${{ secrets.GOOGLE_GEMINI_API_KEY }}
          CLIPDROP_API_KEY: ${{ secrets.CLIPDROP_API_KEY }}
          FREEIMAGE_API_KEY: ${{ secrets.FREEIMAGE_API_KEY }}
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
        run: bundle exec rake pipeline_post:create_post

